---
trigger: none

variables:
  PARAMETERS_FILE_NAME: 'parameters.json'

stages:
  - stage: Validate
    displayName: 'Validate Bicep'
    jobs:
      - job: validate
        displayName: 'Bicep Build & Lint'
        pool:
          ${agent_pool_configuration}
        steps:
          - checkout: self
            displayName: 'Checkout Bicep Module'

          - template: ./helpers/bicep-avm-installer.yaml
            parameters:
              serviceConnection: '${service_connection_name_plan}'

          - task: PowerShell@2
            displayName: 'Bicep Build & Lint All Modules'
            inputs:
              targetType: 'inline'
              pwsh: true
              script: |
                $output = @()
                Get-ChildItem -Recurse -Filter '*.bicep' -Exclude '*.bicep' | Where-Object { $_.FullName -notlike "*\.bicep\*" } | ForEach-Object {
                    Write-Information "==> Attempting Bicep Build For File: $_" -InformationAction Continue
                    $bicepOutput = bicep build $_.FullName 2>&1
                    if ($LastExitCode -ne 0)
                    {
                      foreach ($item in $bicepOutput) {
                        $output += "$($item) `r`n"
                      }
                    }
                    else
                    {
                      echo "Bicep Build Successful for File: $_"
                    }
                }
                if ($output.length -gt 0) {
                  throw $output
                }

  - stage: WhatIf
    displayName: 'What If'
    dependsOn: Validate
    jobs:
      - deployment: whatif
        displayName: 'What If Deployment'
        pool:
          ${agent_pool_configuration}
        environment: '${environment_name_plan}'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout Bicep Module'

                - template: ./helpers/bicep-avm-variables.yaml
                  parameters:
                    parametersFileName: $(PARAMETERS_FILE_NAME)

                - template: ./helpers/bicep-avm-installer.yaml
                  parameters:
                    serviceConnection: '${service_connection_name_plan}'

%{ for script_file in script_files ~}
%{ if try(script_file.networkType, "") != "" ~}
                - template: ./helpers/bicep-avm-deploy.yaml
                  parameters:
                    displayName: '${script_file.displayName} (Network Type: ${script_file.networkType})'
                    serviceConnection: '${service_connection_name_plan}'
                    templateFilePath: '${script_file.templateFilePath}'
                    templateParametersFilePath: '${script_file.templateParametersFilePath}'
                    managementGroupId: '${script_file.managementGroupIdVariable}'
                    subscriptionId: '${script_file.subscriptionIdVariable}'
                    resourceGroupName: '${script_file.resourceGroupNameVariable}'
                    location: '$(LOCATION)'
                    deploymentType: '${script_file.deploymentType}'
                    firstRunWhatIf: ${script_file.firstRunWhatIf}
                    networkType: '${script_file.networkType}'
                    whatIfEnabled: true

%{ else ~}
                - template: ./helpers/bicep-avm-deploy.yaml
                  parameters:
                    displayName: '${script_file.displayName}'
                    serviceConnection: '${service_connection_name_plan}'
                    templateFilePath: '${script_file.templateFilePath}'
                    templateParametersFilePath: '${script_file.templateParametersFilePath}'
                    managementGroupId: '${script_file.managementGroupIdVariable}'
                    subscriptionId: '${script_file.subscriptionIdVariable}'
                    resourceGroupName: '${script_file.resourceGroupNameVariable}'
                    location: '$(LOCATION)'
                    deploymentType: '${script_file.deploymentType}'
                    firstRunWhatIf: ${script_file.firstRunWhatIf}
                    whatIfEnabled: true

%{ endif ~}
%{ endfor ~}
